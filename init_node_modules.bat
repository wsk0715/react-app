@echo off
setlocal


:: Check for administrative permissions
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo Administrative permissions are required to run this script.
    echo Please run this script as an administrator.
    pause
    goto :eof
)


:: Save the script's directory
set "scriptDir=%~dp0"
:: Get the current directory name
for %%i in ("%scriptDir:~0,-1%") do set "currentDirName=%%~nxi"


:: Change to the script's directory
cd /d "%scriptDir%"
:: Print the current directory to verify
echo Current Directory: %cd%


:: Construct the target path
set "targetPath=C:\npm\%currentDirName%"
:: Print the target directory to verify
echo Target Path: %targetPath%


:: Delete existing currentDirName directory if it exists
if exist "%targetPath%" (
    echo Deleting existing %targetPath% directory...
    rmdir /S /Q "%targetPath%"
)
:: Delete existing node_modules directory if it exists
if exist "node_modules" (
    echo Deleting existing node_modules directory...
    rmdir /S /Q "node_modules"
)
:: Delete package-lock.json file if it exists
if exist "package-lock.json" (
    echo Deleting existing package-lock.json file...
    del /F /Q "package-lock.json"
)
:: Delete existing .npmrc file if it exists
if exist ".npmrc" (
    echo Deleting existing .npmrc file...
    del /F /Q ".npmrc"
)


:: Run npm install in a new cmd window and wait for completion
echo Running npm install in a new command prompt...
start /wait cmd /c npm install
if %errorLevel% neq 0 (
    echo npm install failed, exiting...
    pause
    goto :eof
)


:: Ensure the target directory exists
if not exist "%targetPath%" (
    mkdir "%targetPath%"
)
:: Move each subdirectory and file in node_modules to the target path
if exist "node_modules" (
    echo Moving node_modules to target path...
    xcopy "node_modules" "%targetPath%\node_modules" /E /I /H /K /Y
    rmdir /S /Q "node_modules"
)


:: Create the symbolic link
mklink /D "node_modules" "%targetPath%\node_modules"
:: Create .npmrc file with cache setting
echo cache=%targetPath% > .npmrc
echo logs-dir=%targetPath% >> .npmrc
echo tmp=%targetPath% >> .npmrc


:: Print completion message
echo.
echo Completed all tasks successfully.
echo The current directory is %cd%
echo Created .npmrc file with content:
echo cache=%targetPath%
echo logs-dir=%targetPath%
echo tmp=%targetPath%
echo.


:: Run npm start in a new command prompt
start cmd /k "npm start"


endlocal
